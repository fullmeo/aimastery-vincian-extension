// src/trial-manager.ts
import * as vscode from 'vscode';

export class TrialManager {
    private static readonly TRIAL_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 jours
    private static readonly TRIAL_ANALYSES_LIMIT = 3; // 3 analyses gratuites
    
    // üé∫ Informations personnelles de Serigne Diagne
    private static readonly PERSONAL_ACCOUNTS = {
        instagram: '@serigne.diagnepro',
        linkedin: 'Serigne Diagne',
        linkedin_url: 'https://www.linkedin.com/in/serigne-diagne-ab3b9981',
        facebook: 'serignetrumpet1',
        tiktok: '@serigne.diagne',
        creator_name: 'Serigne Diagne',
        instrument: 'Trompette',
        extension_marketplace: 'https://marketplace.visualstudio.com/items?itemName=Serigne-Diagne.aimastery-vincian-analysis',
        creator_email: 'serignetrumpet@gmail.com', // ‚úÖ AJOUT√â
        is_creator: true // ‚úÖ AJOUT√â
    };

    // üíé Plans disponibles avec Creator Pro
    private static readonly PLANS: { [key: string]: any } = {
        free_trial: { name: 'Free Trial', analyses: 3, duration_days: 7, price: 0 },
        social_pack: { name: 'Social Pack', analyses: 50, duration_days: 30, price: 9 },
        pro_vincien: { name: 'Pro Vincien', analyses: -1, duration_days: 30, price: 15 },
        creator_pro: { name: 'Creator Pro', analyses: -1, duration_days: -1, price: 0, exclusive: true }
    };

    // ‚úÖ CORRECTION : V√©rifier si l'utilisateur est le cr√©ateur
    static isCreator(): boolean {
        const config = vscode.workspace.getConfiguration('aimastery');
        const userEmail = config.get('userEmail') as string;
        const creatorKey = config.get('creatorKey') as string;
        
        return (
            userEmail === 'serignetrumpet@gmail.com' ||  // ‚úÖ CORRIG√â
            creatorKey === 'SERIGNE_CREATOR_2024' ||
            this.PERSONAL_ACCOUNTS.is_creator === true   // ‚úÖ CORRIG√â
        );
    }

    // üíé Activer le plan Creator Pro
    static activateCreatorPro(): void {
        if (!this.isCreator()) {
            vscode.window.showErrorMessage('‚ùå Acc√®s r√©serv√© au cr√©ateur Serigne Diagne');
            return;
        }

        const config = vscode.workspace.getConfiguration('aimastery');
        config.update('currentPlan', 'creator_pro', true);
        config.update('creatorProActivated', Date.now(), true);
        config.update('unlimitedAnalyses', true, true);
        config.update('exclusiveFeatures', true, true);

        vscode.window.showInformationMessage(
            'üëë Creator Pro activ√© ! Fonctionnalit√©s exclusives d√©bloqu√©es',
            'Voir Privil√®ges Creator',
            'Dashboard Creator',
            'Analytics Avanc√©es'
        ).then(selection => {
            if (selection === 'Voir Privil√®ges Creator') {
                this.showCreatorPrivileges();
            } else if (selection === 'Dashboard Creator') {
                this.openCreatorDashboard();
            } else if (selection === 'Analytics Avanc√©es') {
                this.showAdvancedAnalytics();
            }
        });
    }

    // üíé Dashboard cr√©ateur
    static openCreatorDashboard(): void {
        if (!this.isCreator()) {
            vscode.window.showErrorMessage('‚ùå Dashboard Creator r√©serv√© √† Serigne Diagne');
            return;
        }

        vscode.env.openExternal(vscode.Uri.parse('https://aimastery.com/creator-dashboard/serigne-diagne'));
        
        vscode.window.showInformationMessage(
            'üìä Creator Dashboard ouvert dans le navigateur',
            'Revenue Analytics',
            'User Metrics',
            'Local Analytics'
        ).then(selection => {
            if (selection === 'Local Analytics') {
                this.showAdvancedAnalytics();
            }
        });
    }

    // üìà Analytics avanc√©es
    static showAdvancedAnalytics(): void {
        if (!this.isCreator()) {
            vscode.window.showErrorMessage('‚ùå Analytics avanc√©es r√©serv√©es au cr√©ateur');
            return;
        }

        const panel = vscode.window.createWebviewPanel(
            'creatorAnalytics',
            'üìä Creator Analytics Dashboard',
            vscode.ViewColumn.Two,
            { enableScripts: true, retainContextWhenHidden: true }
        );

        const personalUsage = vscode.workspace.getConfiguration('aimastery').get('personalUsageCount') as number || 0;
        const conversionRate = this.getConversionRate();
        const totalRevenue = this.getTotalRevenue();

        panel.webview.html = `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                body { 
                    font-family: 'Segoe UI'; 
                    padding: 20px; 
                    background: #1e1e1e; 
                    color: #fff; 
                }
                .header { 
                    text-align: center; 
                    margin-bottom: 30px; 
                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                    padding: 20px;
                    border-radius: 10px;
                    color: #000;
                }
                .chart-container { 
                    background: #2d2d2d; 
                    padding: 20px; 
                    border-radius: 10px; 
                    margin: 15px 0; 
                }
                .metric-row { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 10px 0; 
                    padding: 10px;
                    background: #3d3d3d;
                    border-radius: 5px;
                }
                .creator-badge { 
                    background: #FFD700; 
                    color: #000; 
                    padding: 5px 15px; 
                    border-radius: 15px; 
                    font-weight: bold;
                }
                .value {
                    color: #FFD700;
                    font-weight: bold;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üëë Creator Analytics Dashboard</h1>
                <span class="creator-badge">Serigne Diagne - Creator Pro Access</span>
            </div>
            
            <div class="chart-container">
                <h3>üí∞ Revenue Analytics</h3>
                <div class="metric-row">
                    <span>Total Revenue:</span>
                    <span class="value">‚Ç¨${totalRevenue}</span>
                </div>
                <div class="metric-row">
                    <span>Monthly Growth:</span>
                    <span class="value">+23%</span>
                </div>
                <div class="metric-row">
                    <span>Conversion Rate:</span>
                    <span class="value">${conversionRate}%</span>
                </div>
                <div class="metric-row">
                    <span>MRR Projection:</span>
                    <span class="value">‚Ç¨${(parseInt(totalRevenue) * 1.2).toFixed(0)}</span>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üë• User Analytics</h3>
                <div class="metric-row">
                    <span>Active Users:</span>
                    <span class="value">247</span>
                </div>
                <div class="metric-row">
                    <span>Trial Conversions:</span>
                    <span class="value">32%</span>
                </div>
                <div class="metric-row">
                    <span>User Retention:</span>
                    <span class="value">78%</span>
                </div>
                <div class="metric-row">
                    <span>Daily Active Users:</span>
                    <span class="value">89</span>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üé∫ Personal Creator Usage</h3>
                <div class="metric-row">
                    <span>Creator Analyses:</span>
                    <span class="value">${personalUsage}</span>
                </div>
                <div class="metric-row">
                    <span>Average Score:</span>
                    <span class="value">8.4/10</span>
                </div>
                <div class="metric-row">
                    <span>Best Performance:</span>
                    <span class="value">9.2/10</span>
                </div>
                <div class="metric-row">
                    <span>Improvement Rate:</span>
                    <span class="value">+23%</span>
                </div>
            </div>

            <div class="chart-container">
                <h3>üì± Social Media Impact</h3>
                <div class="metric-row">
                    <span>Instagram Engagement:</span>
                    <span class="value">+45%</span>
                </div>
                <div class="metric-row">
                    <span>LinkedIn Reach:</span>
                    <span class="value">12.3K</span>
                </div>
                <div class="metric-row">
                    <span>TikTok Views:</span>
                    <span class="value">8.7K</span>
                </div>
                <div class="metric-row">
                    <span>Generated Content:</span>
                    <span class="value">${personalUsage * 4} posts</span>
                </div>
            </div>
        </body>
        </html>
        `;
    }

    // üíé Afficher privil√®ges cr√©ateur
    static showCreatorPrivileges(): void {
        vscode.window.showInformationMessage(
            'üëë Creator Pro Privileges Active:\n\n‚Ä¢ Unlimited analyses\n‚Ä¢ Real-time analytics\n‚Ä¢ Exclusive algorithms\n‚Ä¢ Advanced NFT generation\n‚Ä¢ Revenue dashboard\n‚Ä¢ Beta features access\n‚Ä¢ Creator badge\n‚Ä¢ Premium support',
            'Open Dashboard',
            'View Analytics',
            'Generate Content'
        ).then(selection => {
            if (selection === 'Open Dashboard') {
                this.openCreatorDashboard();
            } else if (selection === 'View Analytics') {
                this.showAdvancedAnalytics();
            } else if (selection === 'Generate Content') {
                this.generateCreatorSocialContent({
                    score: 8.7,
                    principles: ['Mouvement', '√âquilibre', 'Harmonie']
                });
            }
        });
    }

    // üé∫ G√©n√©ration de contenu social cr√©ateur
    static generateCreatorSocialContent(analysisResult: any): void {
        const conversionRate = this.getConversionRate();
        const totalRevenue = this.getTotalRevenue();
        const personalUsage = vscode.workspace.getConfiguration('aimastery').get('personalUsageCount') as number || 0;

        const creatorContent = `üé∫ Creator Update - Extension AIMastery v5.3

Analyse personnelle trompette :
üìä Score : ${analysisResult.score || '8.7'}/10
üí∞ Revenus : ‚Ç¨${totalRevenue}
üìà Conversion : ${conversionRate}%
üéØ Analyses perso : ${personalUsage}

Building in public avec ma propre extension ! üöÄ

#CreatorLife #BuildInPublic #VSCode #TrompetteAI`;

        vscode.window.showInformationMessage(
            'üëë Contenu Creator g√©n√©r√© !',
            'Copier Instagram',
            'Copier LinkedIn',
            'Voir Dashboard'
        ).then(selection => {
            if (selection === 'Copier Instagram' || selection === 'Copier LinkedIn') {
                vscode.env.clipboard.writeText(creatorContent);
                vscode.window.showInformationMessage('üìã Contenu copi√© pour Serigne Diagne !');
            } else if (selection === 'Voir Dashboard') {
                this.showAdvancedAnalytics();
            }
        });
    }



    // M√©thode existante generatePersonalSocialContent (si manquante)
    static generatePersonalSocialContent(analysisResult: any): void {
        const conversionRate = this.getConversionRate();
        const totalRevenue = this.getTotalRevenue();
        const personalUsage = vscode.workspace.getConfiguration('aimastery').get('personalUsageCount') as number || 0;
        
        const personalPosts = [
            {
                platform: 'Instagram (@serigne.diagnepro)',
                content: `üé∫ Audio ‚Üí Art Da Vinci avec mon extension VS Code ‚ú®

Analyse de mon dernier enregistrement de trompette avec AIMastery Vincian Analysis !

üìä Score Vincien : ${analysisResult.score || '8.7'}/10
üé® Principes d√©tect√©s : ${analysisResult.principles?.join(', ') || 'Mouvement, √âquilibre, Harmonie'}
üí∞ Revenus extension : ‚Ç¨${totalRevenue}
üìà Taux conversion : ${conversionRate}%
üéØ Mes analyses : ${personalUsage}

Building my own product and using it daily = ultimate validation ! üöÄ

#Trompette #IAMusique #DaVinci #VSCode #BuildInPublic #SerigneDiagne`
            }
        ];

        vscode.window.showInformationMessage(
            `üé∫ Contenu social g√©n√©r√© pour ${this.PERSONAL_ACCOUNTS.creator_name}! Usage: ${personalUsage} analyses`,
            'Copier Instagram',
            'Voir Analytics'
        ).then(selection => {
            if (selection === 'Copier Instagram') {
                vscode.env.clipboard.writeText(personalPosts[0].content);
                vscode.window.showInformationMessage('üìã Contenu Instagram copi√© !');
            } else if (selection === 'Voir Analytics') {
                this.showAdvancedAnalytics();
            }
        });
    }

    // ‚úÖ M√©thodes existantes conserv√©es...
    static isTrialActive(): boolean {
        const trialStart = vscode.workspace.getConfiguration('aimastery').get('trialStartDate') as number;
        if (!trialStart) return false;
        
        const now = Date.now();
        const timeLeft = this.TRIAL_DURATION - (now - trialStart);
        return timeLeft > 0;
    }
    
    static getTrialDaysLeft(): number {
        const trialStart = vscode.workspace.getConfiguration('aimastery').get('trialStartDate') as number;
        if (!trialStart) return 0;
        
        const now = Date.now();
        const timeLeft = this.TRIAL_DURATION - (now - trialStart);
        return Math.max(0, Math.ceil(timeLeft / (24 * 60 * 60 * 1000)));
    }
    
    static getTrialAnalysesLeft(): number {
        const used = vscode.workspace.getConfiguration('aimastery').get('trialAnalysesUsed') as number || 0;
        return Math.max(0, this.TRIAL_ANALYSES_LIMIT - used);
    }
    
    static canUseFreeTrial(): boolean {
        // ‚úÖ MISE √Ä JOUR : Le cr√©ateur a toujours acc√®s illimit√©
        if (this.isCreator()) {
            return true;
        }
        
        return this.isTrialActive() && this.getTrialAnalysesLeft() > 0;
    }
    
    static startTrial(): void {
        const config = vscode.workspace.getConfiguration('aimastery');
        config.update('trialStartDate', Date.now(), true);
        config.update('trialAnalysesUsed', 0, true);
        
        vscode.window.showInformationMessage(
            'üéâ Free Trial Started! 7 days + 3 free Vincian analyses',
            'Start Analyzing',
            'View Features'
        ).then(selection => {
            if (selection === 'Start Analyzing') {
                vscode.commands.executeCommand('aimastery.freeAnalyze');
            } else if (selection === 'View Features') {
                vscode.commands.executeCommand('aimastery.upgradePrompt');
            }
        });
    }
    
    // ‚úÖ MISE √Ä JOUR : useTrialAnalysis avec privil√®ges cr√©ateur
    static useTrialAnalysis(analysisResult?: any): boolean {
        // Cr√©ateur : acc√®s illimit√© sans restrictions
        if (this.isCreator()) {
            const personalUsage = vscode.workspace.getConfiguration('aimastery').get('personalUsageCount') as number || 0;
            vscode.workspace.getConfiguration('aimastery').update('personalUsageCount', personalUsage + 1, true);
            
            if (analysisResult) {
                this.generateCreatorSocialContent(analysisResult);
            }
            
            vscode.window.showInformationMessage(
                `üëë Analyse Creator Pro compl√©t√©e ! Usage personnel : ${personalUsage + 1}`,
                'Generate Creator Content',
                'Analytics Dashboard',
                'Revenue Metrics'
            ).then(selection => {
                if (selection === 'Generate Creator Content') {
                    this.generateCreatorSocialContent(analysisResult);
                } else if (selection === 'Analytics Dashboard') {
                    this.openCreatorDashboard();
                } else if (selection === 'Revenue Metrics') {  // ‚úÖ CORRIG√â
                    this.showAdvancedAnalytics();
                }
            });
            
            return true;
        }

        // Utilisateurs normaux : logique trial existante
        if (!this.canUseFreeTrial()) {
            this.showUpgradePrompt();
            return false;
        }
        
        const used = vscode.workspace.getConfiguration('aimastery').get('trialAnalysesUsed') as number || 0;
        vscode.workspace.getConfiguration('aimastery').update('trialAnalysesUsed', used + 1, true);
        
        const personalUsage = vscode.workspace.getConfiguration('aimastery').get('personalUsageCount') as number || 0;
        vscode.workspace.getConfiguration('aimastery').update('personalUsageCount', personalUsage + 1, true);
        
        if (analysisResult) {
            this.generatePersonalSocialContent(analysisResult);
        }
        
        const remaining = this.getTrialAnalysesLeft();
        if (remaining === 0) {
            vscode.window.showWarningMessage(
                'üéØ Trial analyses used up! Ready to upgrade?',
                'Social Pack (‚Ç¨9)',
                'Pro Vincien (‚Ç¨15)',
                'Maybe later'
            ).then(selection => {
                if (selection === 'Social Pack (‚Ç¨9)') {
                    vscode.commands.executeCommand('aimastery.testSocialPack');
                } else if (selection === 'Pro Vincien (‚Ç¨15)') {
                    vscode.commands.executeCommand('aimastery.testProVincien');
                }
            });
        } else {
            vscode.window.showInformationMessage(
                `‚úÖ Analysis completed! ${remaining} free analyses remaining`,
                'Generate Social Content',
                'Continue Analyzing'
            ).then(selection => {
                if (selection === 'Generate Social Content' && analysisResult) {
                    this.generatePersonalSocialContent(analysisResult);
                }
            });
        }
        
        return true;
    }


    // ‚úÖ NOUVEAU : M√©thode showTrialStatus manquante
    static showTrialStatus(): void {
        const daysLeft = this.getTrialDaysLeft();
        const analysesLeft = this.getTrialAnalysesLeft();
        
        // Cr√©ateur : statut privil√©gi√©
        if (this.isCreator()) {
            vscode.window.showInformationMessage(
                'üëë Creator Pro Status: Unlimited access',
                'Analytics Dashboard',
                'Generate Content',
                'View Privileges'
            ).then(selection => {
                if (selection === 'Analytics Dashboard') {
                    this.showAdvancedAnalytics();
                } else if (selection === 'Generate Content') {
                    this.generateCreatorSocialContent({
                        score: 8.7,
                        principles: ['Mouvement', '√âquilibre', 'Harmonie']
                    });
                } else if (selection === 'View Privileges') {
                    this.showCreatorPrivileges();
                }
            });
            return;
        }
        
        // Utilisateurs normaux : logique trial
        if (!this.isTrialActive()) {
            vscode.window.showWarningMessage(
                '‚è∞ Free trial expired. Upgrade to continue!',
                'Social Pack (‚Ç¨9)',
                'Pro Vincien (‚Ç¨15)'
            ).then(selection => {
                if (selection === 'Social Pack (‚Ç¨9)') {
                    vscode.commands.executeCommand('aimastery.testSocialPack');
                } else if (selection === 'Pro Vincien (‚Ç¨15)') {
                    vscode.commands.executeCommand('aimastery.testProVincien');
                }
            });
        } else {
            vscode.window.showInformationMessage(
                ` Trial Status: ${daysLeft} days, ${analysesLeft} analyses left`,
                'Use Free Analysis',
                'Upgrade Now'
            ).then(selection => {
                if (selection === 'Use Free Analysis') {
                    vscode.commands.executeCommand('aimastery.freeAnalyze');
                } else if (selection === 'Upgrade Now') {
                    vscode.commands.executeCommand('aimastery.upgradePrompt');
                }
            });
        }
    }

    // ‚úÖ MISE √Ä JOUR : Afficher l'invite de mise √† niveau
    static showUpgradePrompt(): void {
        vscode.window.showInformationMessage(
            'üöÄ Passez √† un plan sup√©rieur pour d√©bloquer plus d\'analyses et de fonctionnalit√©s avanc√©es !',
            'Voir les Plans',
            'Essayer une Analyse Gratuite'
        ).then(selection => {
            if (selection === 'Voir les Plans') {
                vscode.commands.executeCommand('aimastery.upgradePrompt');
            } else if (selection === 'Essayer une Analyse Gratuite') {
                this.startTrial();
            }
        });
    }



        // Autres utilisateurs : logique de taux de conversion existante
        const trialStart = config.get('trialStartDate') as number;
        const now = Date.now();
        const timeLeft = this.TRIAL_DURATION - (now - trialStart);
        
        if (timeLeft > 0) {
            // En p√©riode d'essai : taux de conversion bas√© sur l'utilisation d'analyses gratuites
            const usedAnalyses = config.get('trialAnalysesUsed') as number || 0;
            return Math.min(100, (usedAnalyses / this.TRIAL_ANALYSES_LIMIT) * 100);
        } else {
            // Apr√®s la p√©riode d'essai : taux de conversion bas√© sur le plan
            const currentPlan = config.get('currentPlan') as string;
            const plan = this.PLANS[currentPlan];
            
            if (plan) {
                return plan.price > 0 ? 100 : 0; // 100% si abonn√©, 0% sinon
            } else {
                return 0;
            }
        }
    }

    //  M√©thodes utilitaires (version unique et corrig√©e)
    private static getConversionRate(): string {
        const config = vscode.workspace.getConfiguration('aimastery');
        const totalTrials = config.get('totalTrialsStarted') as number || 1;
        const conversions = config.get('totalConversions') as number || 0;
        return ((conversions / totalTrials) * 100).toFixed(1);
    }

    private static getTotalRevenue(): string {
        const config = vscode.workspace.getConfiguration('aimastery');
        const socialPackSales = config.get('socialPackSales') as number || 0;
        const proVincienSales = config.get('proVincienSales') as number || 0;
        const totalRevenue = (socialPackSales * 9) + (proVincienSales * 15);
        return totalRevenue.toString();
    }

}
